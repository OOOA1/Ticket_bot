# Telegram Ticket Bot

## Описание

Telegram Ticket Distribution Bot — это инструмент для автоматизации рассылки электронных билетов и управления участниками закрытых мероприятий в Telegram. Проект предназначен для организаторов, которым требуется централизованная, контролируемая и защищённая рассылка PDF-билетов и уведомлений.

**Основные возможности:**
- Регистрация пользователей только по invite-кодам.
- Массовая рассылка билетов в формате PDF с поддержкой волн.
- Управление пользователями и администраторами через Telegram-интерфейс.
- Формирование Excel-отчётов по пользователям, билетам и рассылкам.
- Контроль успешности доставки, возможность повторных отправок.
- Архивирование невыданных билетов и ведение логов всех операций.

Бот подходит для спортивных, образовательных, деловых и иных событий, где необходим контроль и безопасность при рассылке билетов или информации.

---

## Требования

- Python версии 3.10 или выше.
- Операционная система: Linux, Windows или macOS.
- Аккаунт Telegram для получения токена бота через [BotFather](https://t.me/botfather).
- Все остальные зависимости устанавливаются согласно инструкции в разделе "Установка".



## Установка

```bash
# Клонируйте репозиторий
git clone https://github.com/yourusername/yourbotrepo.git
cd yourbotrepo

# Создайте и активируйте виртуальное окружение
# Для Linux/macOS:
python3 -m venv venv
source venv/bin/activate

# Для Windows:
python -m venv venv
venv\Scripts\activate.bat

# Установите зависимости из requirements.txt
pip install -r requirements.txt
```

---

## Конфигурация

Перед первым запуском создайте файл `config.py` в корневой директории проекта и укажите в нём следующие параметры:

```python
BOT_TOKEN = "ВАШ_ТОКЕН_ОТ_BOTFATHER"         # Сюда вставьте токен, полученный от BotFather при создании бота
BOT_USERNAME = "my_ticket_bot"               # Username вашего telegram-бота (без символа @), например: my_ticket_bot
FOUNDER_IDS = [123456789]                    # Список ваших telegram user_id для административного доступа (можно узнать через /myid)
DEFAULT_TICKET_FOLDER = "tickets"            # Папка для хранения загруженных PDF-билетов (можете оставить по умолчанию)

```

## Запуск бота

Перед запуском убедитесь, что:
- виртуальное окружение (venv) активировано;
- создан и корректно заполнен файл `config.py` в корне проекта.

Затем выполните команду для запуска бота:
```bash
python bot.py
```
- примечание: База данных (`users.db`) создаётся автоматически при первом запуске.

---

## Первые шаги для пользователя

1. Получите у организатора или администратора индивидуальную invite-ссылку для регистрации в системе.

2. Перейдите по этой ссылке в Telegram и нажмите `/start` после принятия пользовательского соглашения на обработку персональных данных.

3. Если у вашего аккаунта отсутствует username, следуйте инструкциям, которые вам предложит бот для его создания. Без username регистрация невозможна.

4. После успешной регистрации вы будете добавлены в список участников рассылки. Все электронные билеты и уведомления будут поступать вам через сообщения от бота.

5. В случае возникновения вопросов обратитесь к администратору системы.

---

## Базовые команды и типовые сценарии для администратора

### Работа с пользователями и администраторами

- `/add_admin @username`  
  Назначить нового администратора.

- `/remove_admin @username`  
  Удалить пользователя из списка администраторов.

- `/export_users`  
  Получить отчёт о всех пользователях и администраторах в Excel-формате.
- `/delete_user user_id @username`  
  Удалить пользователя из системы.

### Работа с invite-кодами
- `/gen_invites N`  
  Сгенерировать N новых invite-кодов для регистрации пользователей. Коды предоставляются в виде Excel-файла.
### Работа с волнами рассылки билетов
- `/new_wave`  
  Начать подготовку новой волны рассылки билетов.

- `/upload_zip`  
  Загрузить архив (ZIP) с PDF-билетами для текущей волны, архивируя оставшиеся билеты с предыдущей волны.

- `/upload_zip_add`  
  Дозагрузить дополнительные билеты в существующую волну (не архивируя уже загруженные).

- `/confirm_wave`  
  Подтвердить запуск волны рассылки (только после загрузки всех билетов).

- `/send_tickets`  
  Выполнить массовую рассылку билетов зарегистрированным пользователям.

- `/end_wave`  
  Завершить текущую волну рассылки.

- `/list_tickets`  
  Получить Excel-отчёт о всех билетах, их статусах и назначении.

### Отчёты и логи

- `/full_report`  
  Сформировать полный отчёт по пользователям, билетам, invite-кодам и неудачным рассылкам (в одном Excel-файле).

- `/failed_report`  
  Получить отчёт по неудачным попыткам доставки билетов.

- `/chatlog user_id` или `/chatlog @username`  
  Получить текстовый лог переписки конкретного пользователя с ботом.

### Массовые рассылки и уведомления
- `/broadcast <текст/медиа>`  
  Выполнить массовую рассылку текстового сообщения, документа, медиа/аудио файла всем пользователям.

### Справка и системные команды

- `/menu`  
  Открыть главное административное меню бота.

- `/help`  
  Получить подробную справку по всем доступным командам.

- `/myid`  
  Узнать свой Telegram user_id (для добавления себя в администраторы).

---


**Типовой сценарий запуска новой волны рассылки:**

1. Создайте новую волну командой `/new_wave`.
2. Загрузите архив с билетами с помощью `/upload_zip`.
3. Подтвердите готовность волны командой `/confirm_wave`.
4. Запустите рассылку билетов командой `/send_tickets`.

После завершения рассылки статистика будет автоматически отправлена в чат администратора. При необходимости можно получить дополнительные отчёты командами.

---

## Принципы работы

### Логика выдачи билетов

- Каждый билет представлен отдельным PDF-файлом, который загружается администратором в систему в виде ZIP-архива.
- Билеты раздаются по принципу «один билет — один пользователь»: каждому зарегистрированному участнику назначается уникальный билет.
- После назначения билет закрепляется за пользователем, и повторная выдача этого же билета другому пользователю невозможна в рамках одной волны рассылки.
- Вся выдача билетов и изменения их статуса фиксируются в базе данных для дальнейшего аудита.

### Механизм рассылки
- Рассылка билетов запускается администратором командой `/send_tickets` после подготовки и подтверждения волны.
- Система последовательно перебирает всех зарегистрированных пользователей (исключая администраторов) и отправляет каждому из них индивидуально назначенный билет.
- В процессе рассылки учитывается, были ли ранее отправлены билеты в текущей волне, чтобы избежать повторных отправок.
- Прогресс рассылки отображается администратору: в чат выводится сообщение после отправки первого билета и далее после каждого двадцатого успешно доставленного билета.
- По завершении рассылки формируется итоговая статистика, которая отправляется администратору в чат.

### Обработка ошибок и контроль доставки
- Если при отправке билета возникает ошибка (например, пользователь заблокировал бота, отсутствует PDF-файл или возникла сетевая проблема), билет считается недоставленным.
- Недоставленные билеты заносятся в отдельный список. После основной рассылки система автоматически повторно пытается доставить такие билеты.
- Все неудачные попытки фиксируются в отчёте (`/failed_report`).
- Если пользователь не может получить билет (например, заблокировал бота или имеет сетевые проблемы), его билет возвращается в список не выданных.

### Управление волнами рассылки
- Все рассылки билетов структурированы по волнам. Каждая волна включает в себя загрузку новых билетов, подтверждение, массовую рассылку и завершение.
- После завершения волны невыданные билеты автоматически архивируются и становятся недоступны для новых пользователей в рамках следующей рассылки.
- Администратор может в любой момент получить подробную статистику и отчёты по текущей волне.

### Логирование и аудит

- Все ключевые действия, связанные с рассылкой билетов, действиями пользователей и администраторов, а также ошибками, логируются системой.
- Логи доступны для анализа и позволяют отслеживать историю изменений, а также проводить аудит рассылок и статусов билетов.

---

## Безопасность

- **Ограниченный доступ по invite-кодам.**  
  Регистрация новых пользователей возможна только по уникальным invite-кодам, которые создаются администраторами. Это исключает доступ случайных пользователей и защищает от массового спама.

- **Требование наличия username у пользователя.**  
  Пользователь не сможет пройти регистрацию и получить билет, если у него не установлен username в Telegram. Это позволяет идентифицировать каждого участника.

- **Разграничение прав доступа.**  
  Все административные функции доступны только пользователям, указанных в параметре `FOUNDER_IDS` или добавленных в качестве администраторов через специальные команды.

- **Логирование попыток несанкционированного доступа.**  
  Все попытки использования административных команд пользователями без соответствующих прав фиксируются системой и могут быть просмотрены администраторами.

- **Контроль повторной выдачи билетов.**  
  Каждый билет может быть выдан только одному пользователю в рамках одной волны рассылки. Исключается возможность получения билета несколько раз или передачи его другому участнику.

- **Обработка неудачных отправок.**  
  В случае возникновения ошибок доставки (например, пользователь заблокировал бота или возникла техническая проблема) билеты возвращаются в пул и могут быть выданы повторно либо заархивированы.

- **Защита от рассылки спама.**  
  Бот не осуществляет массовые рассылки сторонним пользователям; все уведомления отправляются только зарегистрированным участникам системы.

### Рекомендации по безопасной работе

- Не передавайте invite-коды и административные права третьим лицам.
- Храните файл `config.py` и базу данных в недоступном для посторонних месте.
- Регулярно проверяйте список администраторов и пользователей на наличие подозрительных активностей.
- Используйте надёжные пароли и двухфакторную аутентификацию для вашего Telegram-аккаунта.
- Регулярно создавайте резервные копии базы данных (`users.db`) и других важных файлов проекта.

---

## Структура проекта

Проект построен по модульному принципу для удобства поддержки и масштабирования. Основные папки и файлы:

.
├── admin_panel/                     # Модуль с обработчиками команд и вспомогательными скриптами для админов
│   ├── __init__.py                  # Регистрация обработчиков
│   ├── admin_menu.py                # Логика админского меню и интерфейса
│   ├── handlers_admins.py           # Управление администраторами
│   ├── handlers_broadcast.py        # Массовые рассылки и уведомления
│   ├── handlers_help.py             # Обработка команд помощи
│   ├── handlers_invites.py          # Работа с invite-кодами
│   ├── handlers_mass_send.py        # Массовая рассылка билетов
│   ├── handlers_report.py           # Генерация полного Excel-отчёта
│   ├── handlers_tickets.py          # Работа с билетами
│   ├── handlers_wave.py             # Работа с волнами рассылки
│   ├── invite_admin.py              # Генерация и обработка invite-кодов
│   ├── utils.py                     # Вспомогательные функции
│   └── __pycache__/                 # Кеш байткода Python (создаётся автоматически)
├── archive/                         # Папка для архивированных файлов и билетов
├── logs/                            # Логи работы бота
├── tickets/                         # Каталог для хранения PDF-билетов
├── venv/                            # Виртуальное окружение Python (создаётся автоматически)
├── .gitignore                       # Файл исключений для git
├── bot.py                           # Основной файл запуска бота
├── bot_errors.log                   # Лог ошибок бота
├── config.py                        # Основной файл настроек (создаётся вручную)
├── database.py                      # Работа с базой данных пользователей и билетов
├── readme.md                        # Документация по проекту
├── README_TicketBot.txt             # Альтернативный текстовый файл с документацией
├── requirements.txt                 # Список зависимостей для установки
├── users.db                         # База данных пользователей и билетов (создаётся автоматически)

Примечания:
- Все основные действия по настройке и запуску выполняются из корневой директории проекта.
- Файл `users.db` и папка `tickets/` создаются при первом запуске.
- Папка `venv/` рекомендуется добавить в `.gitignore` и не хранить в репозитории.
- Папка `archive/` используется для хранения архивированных билетов и файлов рассылок.
- Файл `bot_errors.log` содержит логи ошибок работы бота.
---
